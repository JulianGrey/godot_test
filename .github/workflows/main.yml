name: "Godot CI/CD"

# 1. Trigger on push to main
on:
  push:
    branches:
      - main
    tags:
        - 'v*'

# 2. Environment variables
env:
  GODOT_VERSION: 4.6 # Make sure this matches your project version!
  EXPORT_NAME: top_down_chaos

# 3. PERMISSIONS (Crucial Fix)
permissions:
  contents: write

jobs:
  export_game:
    name: Export Game
    runs-on: ubuntu-latest
    
    steps:
      # A. Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # A2. Inject Version and Build Number
      - name: Inject Version
        # Note: We remove the 'if' so build numbers increment even on non-tag pushes
        run: |
          # Inject the version (Tag name or "main")
          sed -i "s/DEV_BUILD/${{ github.ref_name }}/g" Global.gd
          
          # Inject the build number (Global incrementing counter)
          sed -i "s/var build_number: String = \"0\"/var build_number: String = \"${{ github.run_number }}\"/g" Global.gd

      # B. Setup Godot & Export
      # This action handles downloading Godot and templates for you.
      - name: Build Web & Windows
        uses: firebelley/godot-export@v5.2.1
        with:
          godot_executable_download_url: https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          relative_project_path: ./
          archive_output: true # Zips the build automatically
          cache: true # Caches Godot and templates for faster builds

      # C. Upload Artifacts (So you can download them from the Actions tab)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-builds
          path: /home/runner/.local/share/godot/archives/ # Default output of the action

  # OPTIONAL: Deploy to GitHub Pages
  deploy_web:
    needs: export_game
    runs-on: ubuntu-latest
    steps:
      # 1. CHECKOUT IS MANDATORY HERE TOO
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Download the build
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: game-builds
          path: builds
      
      # 3. Prepare the folder
      - name: Unzip Web Build
        run: |
          mkdir public
          unzip builds/Web.zip -d public

      # 4. Deploy
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages
          single-commit: true

  publish_release:
    needs: export_game
    if: startsWith(github.ref, 'refs/tags/') # ONLY run on tags
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: game-builds
          path: builds

      - name: Rename Windows Build
        run: mv builds/Windows\ Desktop.zip Windows_Build.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Windows_Build.zip
            builds/Web.zip
            builds/macOS.zip
          generate_release_notes: true # Auto-generates changelog from commits!